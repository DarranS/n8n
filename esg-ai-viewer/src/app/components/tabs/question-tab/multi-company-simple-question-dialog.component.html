<div class="dialog-container">
  <h2>Ask a Question ({{ data.companies.length }} Companies)</h2>
  <mat-tab-group>
    <mat-tab label="Guided">
      <app-guided-question-tab
        [companyName]="'{{COMPANY_NAME}}'"
        [companyIsin]="'{{COMPANY_ISIN}}'"
        [loading]="loading"
        [audienceOptions]="audienceOptions"
        [toneOptions]="toneOptions"
        [depthOptions]="depthOptions"
        [outputFormatOptions]="outputFormatOptions"
        [warning]="warning"
        [guidedPromptOutOfDate]="guidedPromptOutOfDate"
        [generatedPrompt]="generatedPrompt"
        [includePromptIntention]="includePromptIntention"
        [includeNumericData]="includeNumericData"
        [perspective]="perspective"
        [question]="question"
        [audience]="audience"
        [tone]="tone"
        [depth]="depth"
        [outputFormat]="outputFormat"
        [isMultiCompany]="true"
        (ask)="handleGuidedAsk()"
        (askAndSave)="handleGuidedAskAndSave()"
        (generatePrompt)="handleGuidedGeneratePrompt()"
        (copyPrompt)="handleGuidedCopyPrompt()"
        (questionChange)="question = $event"
        (audienceChange)="audience = $event"
        (toneChange)="tone = $event"
        (depthChange)="depth = $event"
        (outputFormatChange)="outputFormat = $event"
        (perspectiveChange)="perspective = $event"
        (includeNumericDataChange)="includeNumericData = $event"
        (includePromptIntentionChange)="includePromptIntention = $event"
      ></app-guided-question-tab>
      <div *ngIf="loading" class="loading-container" style="margin-top: 1rem; text-align: center;">
        <mat-spinner diameter="32"></mat-spinner>
        <div style="margin-top: 1rem; font-size: 1.1rem;">{{ statusMessage || 'Processing companies...' }}</div>
      </div>
    </mat-tab>
    <mat-tab label="Simple">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Prompt</mat-label>
        <textarea matInput [(ngModel)]="prompt" name="prompt" rows="4" [readonly]="loading"></textarea>
      </mat-form-field>
      <div class="form-actions">
        <button mat-raised-button color="primary" (click)="togglePromptPreview()" [disabled]="loading || !prompt.trim()">
          {{ showPromptPreview ? 'Hide Prompt' : 'Show Prompt' }}
        </button>
        <button mat-raised-button color="accent" (click)="askAndSave()" [disabled]="loading || !prompt.trim()">
          <mat-icon>description</mat-icon>
          Ask & Save
        </button>
        <button *ngIf="results.length > 0" mat-raised-button color="accent" (click)="exportResults()" [disabled]="loading" style="margin-left: 1rem;">
          <mat-icon>download</mat-icon>
          Export Results
        </button>
      </div>
      <div *ngIf="showPromptPreview" class="generated-prompt" style="margin-bottom: 1rem;">
        <b>Generated Prompt:</b>
        <div style="white-space: pre-line;">{{ generatedPrompt }}</div>
      </div>
      <div *ngIf="loading" class="loading-container" style="margin-top: 1rem; text-align: center;">
        <mat-spinner diameter="32"></mat-spinner>
        <div style="margin-top: 1rem; font-size: 1.1rem;">{{ statusMessage || 'Processing companies...' }}</div>
      </div>
      <div *ngIf="results.length > 0" class="results-area" style="margin-top: 2rem;">
        <div class="generated-prompt" style="margin-bottom: 1rem;">
          <b>Generated Prompt:</b>
          <div style="white-space: pre-line;">{{ generatedPrompt }}</div>
        </div>
        <div class="answer-area">
          <b>Answer:</b>
          <div style="white-space: pre-line;">{{ results[0].answer }}</div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
  <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
    <button mat-raised-button color="warn" (click)="close()">Cancel</button>
  </div>
</div> 